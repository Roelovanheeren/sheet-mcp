name: Sheets CI (OIDC)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

jobs:
  test-mcp:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to Google Cloud (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: google-sheets-mcp@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com
          create_credentials_file: true
          export_environment_variables: true

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib

      - name: List a few Drive files in the folder
        env:
          DRIVE_FOLDER_ID: ${{ secrets.DRIVE_FOLDER_ID }}
        run: |
          python - << 'PY'
          from googleapiclient.discovery import build
          from googleapiclient.errors import HttpError

          folder = "${{ secrets.DRIVE_FOLDER_ID }}"
          try:
              svc = build("drive", "v3")
              q = f"'{folder}' in parents and trashed=false"
              resp = svc.files().list(q=q, fields="files(id,name,mimeType)").execute()
              files = resp.get("files", [])
              if not files:
                  print("Folder is accessible but empty.")
              else:
                  for f in files[:20]:
                      print(f"{f['name']}  {f['id']}  {f['mimeType']}")
          except HttpError as e:
              print(e)
              raise
          PY
